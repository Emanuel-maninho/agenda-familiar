<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Familiar</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 14px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 22px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3436;
            margin-bottom: 6px;
        }

        .header p {
            font-size: 0.95rem;
            color: #636e72;
        }

        .controls {
            padding: 14px 18px;
            background: #fafafa;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: 0.2s ease;
            white-space: nowrap;
        }

        .btn-primary {
            background: #4c6ef5;
            color: white;
        }

        .btn-primary:hover {
            background: #3b5bdb;
        }

        .btn-secondary {
            background: #ced4da;
            color: #2d3436;
        }

        .btn-secondary:hover {
            background: #bfc6cc;
        }

        .btn-export {
            background: #20c997;
            color: white;
        }

        .btn-export:hover {
            background: #17a589;
        }

        .view-selector {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .view-btn {
            padding: 6px 10px;
            background: white;
            border: 1px solid #4c6ef5;
            color: #4c6ef5;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: 0.2s ease;
        }

        .view-btn.active {
            background: #4c6ef5;
            color: white;
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
            flex-wrap: wrap;
            font-size: 13px;
        }

        .calendar-container {
            padding: 0 10px 10px 10px;
            flex: 1;
            overflow-x: auto;
            overflow-y: auto;
            max-height: calc(100vh - 230px);
        }

        .calendar {
            min-width: 900px;
            border-collapse: collapse;
            width: 100%;
        }

        .calendar thead th {
            background: #4c6ef5;
            color: white;
            padding: 8px;
            font-weight: 600;
            text-align: center;
            border: 1px solid #3b5bdb;
            position: sticky;
            top: 0;
            z-index: 102;
            font-size: 12px;
        }
        
        .calendar thead th:first-child {
            z-index: 103;
            left: 0;
            position: sticky;
        }

        .calendar tbody tr td:first-child {
            position: sticky;
            left: 0;
            z-index: 101;
        }

        .calendar td {
            border: 1px solid #e5e7eb;
            padding: 3px;
            vertical-align: top;
            min-height: 40px;
            height: 40px;
            position: relative;
            background: white;
            overflow: visible;
        }
        
        .calendar tbody td:first-child {
            overflow: visible;
        }

        .calendar td:hover {
            background: #f1f3f5;
        }

        .time-cell {
            background: #f1f3f5;
            font-weight: 600;
            text-align: center;
            color: #495057;
            width: 60px;
            position: sticky;
            left: 0;
            z-index: 101;
            font-size: 11px;
            box-shadow: 2px 0 4px rgba(0,0,0,0.05);
        }

        .event {
            color: white;
            padding: 4px 4px;
            margin: 1px 0;
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
            transition: 0.2s ease;
            word-wrap: break-word;
            position: absolute;
            overflow: visible;
            min-height: 36px;
            line-height: 1.2;
            z-index: 10;
            box-sizing: border-box;
            white-space: normal;
        }

        .event:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .event.recurrent {
            border-left: 4px solid #f1c40f;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            max-width: 420px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .modal-content h2 {
            margin-bottom: 14px;
            color: #4c6ef5;
            font-size: 18px;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #495057;
            font-size: 13px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 13px;
            background: #fafafa;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4c6ef5;
            background: white;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
        }

        .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .btn-delete {
            background: #e03131;
            color: white;
        }

        .btn-delete:hover {
            background: #c92a2a;
        }

        .legend {
            padding: 10px 12px;
            background: #fafafa;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            font-weight: 600;
            color: #444;
            font-size: 15px;
        }
    </style>
</head>

<body>
<div class="container">

    <!-- CABE√áALHO PRINCIPAL -->
    <div class="header" id="pdfHeader">
        <h1>üìÖ Agenda Familiar</h1>
        <p>Fam√≠lia: Emanuel, Sue Ellen, Emanuel Jr, Maria Eduarda e Andr√©</p>
    </div>

    <!-- BARRA DE CONTROLES -->
    <div class="controls" id="pdfControls">
        <button class="btn btn-primary" onclick="openAddEventModal()">‚ûï Adicionar Evento</button>

        <button class="btn btn-export" onclick="exportWeekToPDF()">üìÑ Exportar PDF</button>

        <div class="view-selector">
            <button class="view-btn active" onclick="changeView('geral', this)">Geral</button>
            <button class="view-btn" onclick="changeView('Emanuel', this)">Emanuel</button>
            <button class="view-btn" onclick="changeView('Sue Ellen', this)">Sue Ellen</button>
            <button class="view-btn" onclick="changeView('Emanuel Jr', this)">Emanuel Jr</button>
            <button class="view-btn" onclick="changeView('Maria Eduarda', this)">Maria Eduarda</button>
            <button class="view-btn" onclick="changeView('Andr√©', this)">Andr√©</button>
        </div>

        <div class="week-nav">
            <button class="btn btn-secondary" onclick="changeWeek(-1)">‚Üê Semana anterior</button>
            <span id="weekDisplay" style="font-weight: 600;"></span>
            <button class="btn btn-secondary" onclick="changeWeek(1)">Semana seguinte ‚Üí</button>
        </div>
    </div>

    <!-- √ÅREA DA AGENDA -->
    <div class="calendar-container" id="pdfCalendar">
        <table class="calendar" id="calendar"></table>
    </div>

    <!-- LEGENDA -->
    <div class="legend"></div>

</div>

<!-- MODAL DE EVENTO -->
<div class="modal" id="eventModal">
    <div class="modal-content">
        <h2 id="modalTitle">Adicionar Evento</h2>
        <form id="eventForm">
        <div class="form-group">
            <label>T√≠tulo do Evento</label>
            <input type="text" id="eventTitle" required>
        </div>

        <div class="form-group">
            <label>Descri√ß√£o</label>
            <textarea id="eventDescription" rows="3"></textarea>
        </div>

        <div class="form-group">
            <label>Data</label>
            <input type="date" id="eventDate" required>
        </div>

        <div class="form-group">
            <label>Hor√°rio de In√≠cio</label>
            <input type="time" id="eventStartTime" required>
        </div>

        <div class="form-group">
            <label>Hor√°rio de T√©rmino</label>
            <input type="time" id="eventEndTime" required>
        </div>

        <div class="form-group">
            <label>Membros da Fam√≠lia</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" value="Emanuel">
                    <label>Emanuel</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" value="Sue Ellen">
                    <label>Sue Ellen</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" value="Emanuel Jr">
                    <label>Emanuel Jr</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" value="Maria Eduarda">
                    <label>Maria Eduarda</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" value="Andr√©">
                    <label>Andr√©</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Recorr√™ncia</label>
            <select id="eventRecurrence" onchange="toggleRecurrenceEnd()">
                <option value="none">Evento √∫nico</option>
                <option value="daily">Diariamente</option>
                <option value="weekdays">Dias de trabalho (Seg-Sex)</option>
                <option value="weekly">Semanalmente</option>
                <option value="monthly">Mensalmente</option>
            </select>
        </div>

        <div class="form-group" id="recurrenceEndGroup" style="display: none;">
            <label>Repetir at√© (Data Final)</label>
            <input type="date" id="eventRecurrenceEnd">
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Salvar</button>
            <button type="button" class="btn btn-delete" id="deleteBtn" style="display:none;" onclick="deleteEvent()">Excluir</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        </div>

    </form>
</div>
</div>

<div class="loading-overlay" id="loadingOverlay" style="display:none;">
    Carregando agenda...
</div>
<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxMD0OzNc1jpgnqCsP5EfF1PGBija7XnNqGvo1fpJsS5sekKK70iRSGoyOaX_0rRDDH/exec';

    const familyMembers = ['Emanuel', 'Sue Ellen', 'Emanuel Jr', 'Maria Eduarda', 'Andr√©'];

    const memberColors = {
        'Emanuel': '#28a745',
        'Sue Ellen': '#007bff',
        'Emanuel Jr': '#6c757d',
        'Maria Eduarda': '#e83e8c',
        'Andr√©': '#ffc107'
    };

    let events = [];
    const listaContatos = {
        "Emanuel": "5527981797670",
        "Sue Ellen": "5527981127917",
        "Emanuel Jr": "5527988615270",
        "Maria Eduarda": "5527992640850",
        "Andr√©": "5527981127917"
        // Adicione os outros membros conforme sua planilha
    };
    let currentView = 'geral';
    let currentWeekStart = getWeekStart(new Date());
    let editingEventId = null;
    let editingEventDate = null;

    function showLoading(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

/*    function getWeekStart(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day;
        return new Date(d.setDate(diff));
    }
*/
    function getWeekStart(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day;
        const weekStart = new Date(d.setDate(diff));
        weekStart.setHours(0, 0, 0, 0);
        return weekStart;
    }
    
/*    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }
*/
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

/*    function formatDateBR(date) {
        return date.toLocaleDateString('pt-BR');
    }
*/
    function formatDateBR(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }
    
    function changeWeek(direction) {
        const newDate = new Date(currentWeekStart);
        newDate.setDate(newDate.getDate() + (direction * 7));
        currentWeekStart = newDate;
        renderCalendar();
    }

    function changeView(view, btnElement) {
        currentView = view;
        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        btnElement.classList.add('active');
        renderCalendar();
    }

    function openAddEventModal() {
        editingEventId = null;
        editingEventDate = null;
        document.getElementById('modalTitle').textContent = 'Adicionar Evento';
        document.getElementById('eventForm').reset();
        document.getElementById('deleteBtn').style.display = 'none';
        document.getElementById('recurrenceEndGroup').style.display = 'none';
        document.getElementById('eventModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('eventModal').classList.remove('active');
    }

    function openEditEventModal(eventId, eventDate) {
        editingEventId = eventId;
        editingEventDate = eventDate;

        const evt = events.find(e => e.id === eventId);
        if (!evt) return;

        document.getElementById('modalTitle').textContent = 'Editar Evento';
        document.getElementById('eventTitle').value = evt.title || '';
        document.getElementById('eventDescription').value = evt.description || '';
        document.getElementById('eventDate').value = evt.date;
        document.getElementById('eventStartTime').value = evt.startTime;
        document.getElementById('eventEndTime').value = evt.endTime;
        document.getElementById('eventRecurrence').value = evt.recurrence || 'none';
        document.getElementById('eventRecurrenceEnd').value = evt.recurrenceEnd || '';

        if (evt.recurrence && evt.recurrence !== 'none') {
            document.getElementById('recurrenceEndGroup').style.display = 'block';
        }

        familyMembers.forEach(member => {
            const checkbox = document.querySelector(`.checkbox-item input[value="${member}"]`);
            checkbox.checked = evt.people.includes(member);
        });

        document.getElementById('deleteBtn').style.display = 'block';
        document.getElementById('eventModal').classList.add('active');
    }

/*    async function deleteEvent() {
        if (!editingEventId) return;

        const evt = events.find(e => e.id === editingEventId);
        if (!evt) return;

        const choice = prompt(
            "Como deseja excluir?\n\n" +
            "1 - Excluir TODA a s√©rie\n" +
            "2 - Excluir SOMENTE esta ocorr√™ncia\n" +
            "3 - Cancelar"
        );

        if (choice === "1") {
            evt.deleted = true;
            await saveEventToServer(evt);
            events = events.filter(e => e.id !== editingEventId);

        } else if (choice === "2") {
            evt.excludedDates = evt.excludedDates || [];
            if (!evt.excludedDates.includes(editingEventDate)) {
                evt.excludedDates.push(editingEventDate);
            }
            await saveEventToServer(evt);

        } else {
            closeModal();
            return;
        }

        closeModal();
        renderCalendar();
    }
*/

    async function deleteEvent() {
        if (!editingEventId) return;

        const evt = events.find(e => e.id === editingEventId);
        if (!evt) return;

        // Verifica se √© evento √∫nico ou recorrente
        const recurrence = evt.recurrence || 'none';
        const isRecurrent = recurrence !== 'none' && recurrence !== '';

        let choice;
        
        if (isRecurrent) {
            choice = prompt(
                "Como deseja excluir?\n\n" +
                "1 - Excluir TODA a s√©rie\n" +
                "2 - Excluir SOMENTE esta ocorr√™ncia\n" +
                "3 - Cancelar"
            );
        } else {
            choice = confirm("Confirma a exclus√£o deste evento?") ? "1" : "3";
        }

        if (choice === "1") {
            evt.deleted = true;
            await saveEventToServer(evt);
            events = events.filter(e => e.id !== editingEventId);

        } else if (choice === "2") {
            evt.excludedDates = evt.excludedDates || [];
            if (!evt.excludedDates.includes(editingEventDate)) {
                evt.excludedDates.push(editingEventDate);
            }
            await saveEventToServer(evt);

        } else {
            closeModal();
            return;
        }

        closeModal();
        renderCalendar();
    }
    
    function timeToMinutes(time) {
        const [h, m] = time.split(':').map(Number);
        return h * 60 + m;
    }

    function eventsOverlap(a, b) {
        const s1 = timeToMinutes(a.startTime);
        const e1 = timeToMinutes(a.endTime);
        const s2 = timeToMinutes(b.startTime);
        const e2 = timeToMinutes(b.endTime);
        return s1 < e2 && s2 < e1;
    }

    function buildDayLayout(dayEvents) {
        const layout = {};
        if (dayEvents.length === 0) return layout;

        const sorted = [...dayEvents].sort(
            (a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime)
        );

        const columns = [];

        sorted.forEach(evt => {
            let placed = false;

            for (let i = 0; i < columns.length; i++) {
                if (!eventsOverlap(columns[i].event, evt)) {
                    columns[i] = { event: evt, end: timeToMinutes(evt.endTime) };
                    layout[evt.id] = { colIndex: i };
                    placed = true;
                    break;
                }
            }

            if (!placed) {
                const newIndex = columns.length;
                columns.push({ event: evt, end: timeToMinutes(evt.endTime) });
                layout[evt.id] = { colIndex: newIndex };
            }
        });

        const totalCols = columns.length;
        Object.keys(layout).forEach(id => layout[id].totalCols = totalCols);

        return layout;
    }

/*    function buildDayLayout(dayEvents) {
        const layout = {};
        if (dayEvents.length === 0) return layout;

        const sorted = [...dayEvents].sort(
            (a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime)
        );

        const columns = [];

        sorted.forEach(evt => {
            let placed = false;
            for (let i = 0; i < columns.length; i++) {
                if (!eventsOverlap(columns[i].event, evt)) {
                    columns[i] = { event: evt, end: timeToMinutes(evt.endTime) };
                    layout[evt.id] = { colIndex: i };
                    placed = true;
                    break;
                }
            }
            if (!placed) {
                const newIndex = columns.length;
                columns.push({ event: evt, end: timeToMinutes(evt.endTime) });
                layout[evt.id] = { colIndex: newIndex };
            }
        });

        const totalCols = columns.length;
        Object.keys(layout).forEach(id => layout[id].totalCols = totalCols);

        return layout;
    }
*/    
/*    function generateRecurringEvents(baseEvent, startDate, endDate) {
        const recurring = [];

        let current = new Date(baseEvent.date + 'T00:00:00');
        const end = baseEvent.recurrenceEnd
            ? new Date(baseEvent.recurrenceEnd + 'T00:00:00')
            : new Date(endDate);

        const maxEnd = new Date(endDate);
        const finalEnd = end < maxEnd ? end : maxEnd;

        const excludedDates = Array.isArray(baseEvent.excludedDates) 
            ? baseEvent.excludedDates 
            : (baseEvent.excludedDates ? baseEvent.excludedDates.split(',').map(s => s.trim()).filter(Boolean) : []);

        if (baseEvent.recurrence === 'weekdays') {
            let startDay = current.getDay();
            while (startDay === 0 || startDay === 6) {
                current.setDate(current.getDate() + 1);
                startDay = current.getDay();
            }
        }

        while (current <= finalEnd) {
            const currentDateStr = formatDate(current);

            if (current >= new Date(startDate)) {
                const dayOfWeek = current.getDay();

                if (!excludedDates.includes(currentDateStr)) {
                    if (baseEvent.recurrence === 'weekdays') {
                        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                            recurring.push({
                                ...baseEvent,
                                date: currentDateStr,
                                isRecurring: true
                            });
                        }
                    } else {
                        recurring.push({
                            ...baseEvent,
                            date: currentDateStr,
                            isRecurring: true
                        });
                    }
                }
            }

            switch (baseEvent.recurrence) {
                case 'daily': current.setDate(current.getDate() + 1); break;
                case 'weekdays': current.setDate(current.getDate() + 1); break;
                case 'weekly': current.setDate(current.getDate() + 7); break;
                case 'monthly': current.setMonth(current.getMonth() + 1); break;
                default: return recurring;
            }
        }

        return recurring;
    }
*/

    function generateRecurringEvents(baseEvent, startDate, endDate) {
        const recurring = [];
    
        // Cria datas sem convers√£o de timezone
        const [sy, sm, sd] = baseEvent.date.split('-').map(Number);
        let current = new Date(sy, sm - 1, sd);
        
        const [ey, em, ed] = (baseEvent.recurrenceEnd || endDate).split('-').map(Number);
        const end = new Date(ey, em - 1, ed);
    
        const [maxY, maxM, maxD] = endDate.split('-').map(Number);
        const maxEnd = new Date(maxY, maxM - 1, maxD);
        
        const finalEnd = end < maxEnd ? end : maxEnd;
    
        const excludedDates = baseEvent.excludedDates || [];
    
        if (baseEvent.recurrence === 'weekdays') {
            let startDay = current.getDay();
            while (startDay === 0 || startDay === 6) {
                current.setDate(current.getDate() + 1);
                startDay = current.getDay();
            }
        }
    
        const [startY, startM, startD] = startDate.split('-').map(Number);
        const startDateObj = new Date(startY, startM - 1, startD);
    
        while (current <= finalEnd) {
            const currentDateStr = formatDate(current);
    
            if (current >= startDateObj) {
                const dayOfWeek = current.getDay();
    
                if (!excludedDates.includes(currentDateStr)) {
                    if (baseEvent.recurrence === 'weekdays') {
                        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                            recurring.push({
                                ...baseEvent,
                                date: currentDateStr,
                                isRecurring: true
                            });
                        }
                    } else {
                        recurring.push({
                            ...baseEvent,
                            date: currentDateStr,
                            isRecurring: true
                        });
                    }
                }
            }
    
            switch (baseEvent.recurrence) {
                case 'daily': current.setDate(current.getDate() + 1); break;
                case 'weekdays': current.setDate(current.getDate() + 1); break;
                case 'weekly': current.setDate(current.getDate() + 7); break;
                case 'monthly': current.setMonth(current.getMonth() + 1); break;
                default: return recurring;
            }
        }
    
        return recurring;
    }
    
/*    function getEventsForWeek() {
        const weekEnd = new Date(currentWeekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);

        let allEvents = events.filter(e => !e.deleted);

        events.forEach(evt => {
            if (evt.recurrence && evt.recurrence !== 'none' && !evt.deleted) {
                const recurring = generateRecurringEvents(
                    evt,
                    formatDate(currentWeekStart),
                    formatDate(weekEnd)
                );

                allEvents = allEvents.concat(
                    recurring.filter(r => r.date !== evt.date)
                );
            }
        });

        return allEvents.filter(evt => {
            const evtDate = new Date(evt.date + 'T00:00:00');
            return evtDate >= currentWeekStart && evtDate <= weekEnd;
        });
    }
*/

    function getEventsForWeek() {
        const weekEnd = new Date(currentWeekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        weekEnd.setHours(23, 59, 59, 999);
    
        let allEvents = events.filter(e => !e.deleted);
    
        events.forEach(evt => {
            if (evt.recurrence && evt.recurrence !== 'none' && !evt.deleted) {
                const recurring = generateRecurringEvents(
                    evt,
                    formatDate(currentWeekStart),
                    formatDate(weekEnd)
                );
    
                allEvents = allEvents.concat(
                    recurring.filter(r => r.date !== evt.date)
                );
            }
        });
    
        return allEvents.filter(evt => {
            const [y, m, d] = evt.date.split('-').map(Number);
            const evtDate = new Date(y, m - 1, d);
            evtDate.setHours(0, 0, 0, 0);
            
            const weekStart = new Date(currentWeekStart);
            weekStart.setHours(0, 0, 0, 0);
            
            const weekEndComp = new Date(weekEnd);
            weekEndComp.setHours(23, 59, 59, 999);
            
            return evtDate >= weekStart && evtDate <= weekEndComp;
        });
    }
    
/*    function renderCalendar() {
        const calendar = document.getElementById('calendar');
        const weekEvents = getEventsForWeek();

        const weekEnd = new Date(currentWeekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);

        document.getElementById('weekDisplay').textContent =
            `${formatDateBR(currentWeekStart)} - ${formatDateBR(weekEnd)}`;

        let html = '<thead><tr><th>Hor√°rio</th>';

        const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        const daysArray = [];

        for (let i = 0; i < 7; i++) {
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + i);
            date.setHours(0, 0, 0, 0);
            const dateStr = formatDate(date);
            daysArray.push({ date, dateStr });
            html += `<th>${dayNames[date.getDay()]}<br>${formatDateBR(date)}</th>`;
        }
        
        html += '</tr></thead><tbody>';

        const layoutsByDay = {};
        daysArray.forEach(({ dateStr }) => {
            const dayEvents = weekEvents.filter(evt =>
                evt.date === dateStr &&
                (currentView === 'geral' || evt.people.includes(currentView))
            );
            layoutsByDay[dateStr] = buildDayLayout(dayEvents);
        });

        const renderedEvents = new Set();

        for (let hour = 0; hour < 24; hour++) {
            html += `<tr><td class="time-cell">${hour.toString().padStart(2, '0')}:00</td>`;

            for (let day = 0; day < 7; day++) {
                const { dateStr } = daysArray[day];

                const cellEvents = weekEvents.filter(evt => {
                    if (evt.date !== dateStr) return false;
                    if (currentView !== 'geral' && !evt.people.includes(currentView)) return false;
                    const evtHour = parseInt(evt.startTime.split(':')[0]);
                    return evtHour === hour || (evtHour < hour && parseInt(evt.endTime.split(':')[0]) > hour);
                });

                html += '<td>';

                const layoutForDay = layoutsByDay[dateStr] || {};

                cellEvents.forEach(evt => {
                    const key = `${evt.id}-${dateStr}`;
                    if (renderedEvents.has(key)) return;
                    renderedEvents.add(key);

                    const [startH, startM] = evt.startTime.split(':').map(Number);
                    const [endH, endM] = evt.endTime.split(':').map(Number);
                    const duration = (endH + endM / 60) - (startH + startM / 60);
                    
                    // Altura din√¢mica: eventos curtos ficam maiores para mostrar todo o texto
                    const baseHeight = duration * 60 * 0.8;
                    const minHeight = 60; // Altura m√≠nima maior para garantir legibilidade
                    const height = Math.max(baseHeight, minHeight);

                    const info = layoutForDay[evt.id] || { colIndex: 0, totalCols: 1 };
                    const width = 100 / info.totalCols;
                    const left = info.colIndex * width;

                    const bgColor = memberColors[evt.people[0]] || '#4c6ef5';
                    const borderColors = evt.people.slice(1)
                        .map(p => memberColors[p])
                        .filter(Boolean);

                    const boxShadow = borderColors
                        .map((color, i) => `0 0 0 ${(i + 1) * 2}px ${color}`)
                        .join(', ');

                    const classes = `event ${evt.isRecurring ? 'recurrent' : ''}`;

                    html += `
                        <div class="${classes}"
                             onclick="openEditEventModal('${evt.id}', '${dateStr}')"
                             style="
                                height:${height}px;
                                width:${width}%;
                                left:${left}%;
                                top:0;
                                background:${bgColor};
                                box-shadow:${boxShadow || 'none'};
                             ">
                            ${evt.isRecurring
                                ? '<span style="position:absolute; top:2px; right:4px; font-size:12px;">üîÅ</span>'
                                : ''
                            }
                            <strong>${evt.title}</strong><br>
                            ${evt.startTime} - ${evt.endTime}<br>
                            <small>${evt.people.join(', ')}</small>
                        </div>
                    `;
                });

                html += '</td>';
            }

            html += '</tr>';
        }

        html += '</tbody>';
        calendar.innerHTML = html;

        const legend = document.querySelector('.legend');
        legend.innerHTML = `
            ${Object.entries(memberColors).map(([name, color]) => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${color};"></div>
                    <span>${name}</span>
                </div>
            `).join('')}
            <div class="legend-item">
                <div class="legend-color" style="background: white; border: 2px solid #333;"></div>
                <span>Evento com m√∫ltiplas pessoas (bordas coloridas)</span>
            </div>
            <div class="legend-item">
                <span style="font-size: 16px;">üîÅ</span>
                <span>Evento recorrente</span>
            </div>
        `;
    }
*/

    function renderCalendar() {
        const calendar = document.getElementById('calendar');
        const weekEvents = getEventsForWeek();
    
        const weekEnd = new Date(currentWeekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
    
        document.getElementById('weekDisplay').textContent =
            `${formatDateBR(currentWeekStart)} - ${formatDateBR(weekEnd)}`;
    
        let html = '<thead><tr><th>Hor√°rio</th>';
    
        const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        const daysArray = [];
    
        for (let i = 0; i < 7; i++) {
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + i);
            date.setHours(0, 0, 0, 0);
            const dateStr = formatDate(date);
            daysArray.push({ date, dateStr });
            html += `<th>${dayNames[date.getDay()]}<br>${formatDateBR(date)}</th>`;
        }
        
        html += '</tr></thead><tbody>';
    
        const layoutsByDay = {};
        daysArray.forEach(({ dateStr }) => {
            const dayEvents = weekEvents.filter(evt =>
                evt.date === dateStr &&
                (currentView === 'geral' || evt.people.includes(currentView))
            );
            layoutsByDay[dateStr] = buildDayLayout(dayEvents);
        });
    
        const renderedEvents = new Set();
    
        for (let hour = 0; hour < 24; hour++) {
            html += `<tr><td class="time-cell">${hour.toString().padStart(2, '0')}:00</td>`;
    
            for (let day = 0; day < 7; day++) {
                const { dateStr } = daysArray[day];
    
                const cellEvents = weekEvents.filter(evt => {
                    if (evt.date !== dateStr) return false;
                    if (currentView !== 'geral' && !evt.people.includes(currentView)) return false;
                    const evtHour = parseInt(evt.startTime.split(':')[0]);
                    return evtHour === hour || (evtHour < hour && parseInt(evt.endTime.split(':')[0]) > hour);
                });
    
                html += '<td>';
    
                const layoutForDay = layoutsByDay[dateStr] || {};
    
                cellEvents.forEach(evt => {
                    const key = `${evt.id}-${dateStr}`;
                    if (renderedEvents.has(key)) return;
                    renderedEvents.add(key);
    
                    const [startH, startM] = evt.startTime.split(':').map(Number);
                    const [endH, endM] = evt.endTime.split(':').map(Number);
                    const duration = (endH + endM / 60) - (startH + startM / 60);
                    
                    const baseHeight = duration * 60 * 0.8;
                    const minHeight = 60; 
                    const height = Math.max(baseHeight, minHeight);
    
                    const info = layoutForDay[evt.id] || { colIndex: 0, totalCols: 1 };
                    const width = 100 / info.totalCols;
                    const left = info.colIndex * width;
    
                    const bgColor = memberColors[evt.people[0]] || '#4c6ef5';
                    const borderColors = evt.people.slice(1)
                        .map(p => memberColors[p])
                        .filter(Boolean);
    
                    const boxShadow = borderColors
                        .map((color, i) => `0 0 0 ${(i + 1) * 2}px ${color}`)
                        .join(', ');
    
                    const classes = `event ${evt.isRecurring ? 'recurrent' : ''}`;
    
                    // --- GERA√á√ÉO DOS BOT√ïES DE WHATSAPP ---
                    const zapsHtml = evt.people.map(p => {
                        // Escapamos as aspas para n√£o quebrar o HTML
                        const tituloEscapado = evt.title.replace(/'/g, "\\'");
                        const descEscapada = (evt.description || "").replace(/'/g, "\\'").replace(/\n/g, " ");
                    
                        return `<span onclick="event.stopPropagation(); enviarZap('${tituloEscapado}', '${p.trim()}', '${descEscapada}')" 
                               style="cursor:pointer; background:white; border-radius:50%; width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center; margin-left:2px; border:1px solid #25D366; font-size:10px;" 
                               title="Zap para ${p}">üü¢</span>`;
                    }).join('');
    
                    html += `
                        <div class="${classes}"
                             onclick="openEditEventModal('${evt.id}', '${dateStr}')"
                             style="
                                height:${height}px;
                                width:${width}%;
                                left:${left}%;
                                top:0;
                                background:${bgColor};
                                box-shadow:${boxShadow || 'none'};
                                display: flex;
                                flex-direction: column;
                                justify-content: space-between;
                             ">
                            <div>
                                ${evt.isRecurring ? '<span style="float:right;">üîÅ</span>' : ''}
                                <strong>${evt.title}</strong><br>
                                <small>${evt.startTime} - ${evt.endTime}</small>
                            </div>
                            <div style="display:flex; justify-content:flex-end; padding-bottom:2px;">
                                ${zapsHtml}
                            </div>
                        </div>
                    `;
                });
    
                html += '</td>';
            }
    
            html += '</tr>';
        }
    
        html += '</tbody>';
        calendar.innerHTML = html;
    
        // Atualiza a legenda
        const legend = document.querySelector('.legend');
        legend.innerHTML = `
            ${Object.entries(memberColors).map(([name, color]) => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${color};"></div>
                    <span>${name}</span>
                </div>
            `).join('')}
        `;
    }
    
    function toggleRecurrenceEnd() {
        const recurrence = document.getElementById('eventRecurrence').value;
        document.getElementById('recurrenceEndGroup').style.display =
            recurrence !== 'none' ? 'block' : 'none';
    }

    function serializeEvent(evt) {
        return {
            id: evt.id,
            title: evt.title || '',
            description: evt.description || '',
            date: evt.date,
            startTime: evt.startTime,
            endTime: evt.endTime,
            people: evt.people.join(','),
            recurrence: evt.recurrence || 'none',
            recurrenceEnd: evt.recurrenceEnd || '',
            excludedDates: (evt.excludedDates || []).join(','),
            deleted: evt.deleted ? 'true' : ''
        };
    }

    function deserializeEvent(row) {
        // Fun√ß√£o para extrair HH:mm ignorando timezone
        function parseTimeField(value) {
            if (!value) return "";
            
            // Se j√° est√° no formato HH:mm correto
            if (typeof value === 'string' && /^\d{2}:\d{2}$/.test(value)) {
                return value;
            }
            
            // Se cont√©m 'T' (ISO do Sheets) - IGNORA timezone
            if (typeof value === 'string' && value.includes('T')) {
                // Extrai apenas a parte do hor√°rio, ignorando o Z
                const match = value.match(/T(\d{2}):(\d{2})/);
                if (match) {
                    return `${match[1]}:${match[2]}`;
                }
            }
            
            return "";
        }
    
        function parseDateField(value) {
            if (!value) return "";
            if (typeof value === 'string') {
                return value.split('T')[0];
            }
            return "";
        }
    
        return {
            id: String(row.id),
            title: row.title || '',
            description: row.description || '',
            startTime: parseTimeField(row.startTime),
            endTime: parseTimeField(row.endTime),
            date: parseDateField(row.date),
            people: typeof row.people === 'string' ? row.people.split(',').map(s => s.trim()).filter(Boolean) : [],
            recurrence: row.recurrence || 'none',
            recurrenceEnd: parseDateField(row.recurrenceEnd),
            excludedDates: typeof row.excludedDates === 'string' ? row.excludedDates.split(',').map(s => s.trim()).filter(Boolean) : [],
            deleted: row.deleted === 'true' || row.deleted === true
        };
    }

    async function saveEventToServer(evt) {
        const payload = serializeEvent(evt);

        try {
            await fetch(API_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8'
                },
                body: JSON.stringify(payload)
            });
            
            // Aguarda 2 segundos para o Google Sheets processar
            await new Promise(resolve => setTimeout(resolve, 2000));
            
        } catch (e) {
            alert('Erro ao salvar evento no servidor.');
            console.error(e);
        }
    }
    
    async function loadEvents() {
        showLoading(true);
        try {
            console.log("Script carregado!");
            console.log("Carregando eventos da API...");
            console.log("URL usada:", API_URL + '?nocache=' + new Date().getTime());
            const response = await fetch(API_URL + '?nocache=' + new Date().getTime());
            const data = await response.json();
            console.log("Eventos recebidos:", data);
            
            events = data
                .map(deserializeEvent)
                .filter(evt => !evt.deleted); // Filtra eventos deletados
            
            renderCalendar();
        } catch (e) {
            console.error('Erro ao carregar eventos:', e);
            alert('Erro ao carregar eventos do servidor.');
        } finally {
            showLoading(false);
        }
    }
    document.getElementById('eventForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const title = document.getElementById('eventTitle').value.trim();
        const description = document.getElementById('eventDescription').value.trim();
        const date = document.getElementById('eventDate').value;
        const startTime = document.getElementById('eventStartTime').value;
        const endTime = document.getElementById('eventEndTime').value;
        const recurrence = document.getElementById('eventRecurrence').value;
        const recurrenceEnd = document.getElementById('eventRecurrenceEnd').value;

        const people = [...document.querySelectorAll('.checkbox-item input:checked')]
            .map(cb => cb.value);

        if (people.length === 0) {
            alert('Selecione pelo menos uma pessoa.');
            return;
        }

        let evt;

        if (editingEventId) {
            evt = events.find(e => e.id === editingEventId);
            evt.title = title;
            evt.description = description;
            evt.date = date;
            evt.startTime = startTime;
            evt.endTime = endTime;
            evt.people = people;
            evt.recurrence = recurrence;
            evt.recurrenceEnd = recurrenceEnd;
        } else {
            evt = {
                id: Date.now().toString(),
                title,
                description,
                date,
                startTime,
                endTime,
                people,
                recurrence,
                recurrenceEnd,
                excludedDates: [],
                deleted: false
            };
            events.push(evt);
        }

        await saveEventToServer(evt);
        closeModal();
        renderCalendar();
        
    });

    loadEvents();
    function enviarZap(titulo, pessoa, descricao) {
        const telefone = listaContatos[pessoa];
        if (!telefone) {
            alert("N√∫mero de telefone n√£o encontrado para " + pessoa);
            return;
        }
    
        // Monta a mensagem com descri√ß√£o se ela existir
        let texto = `*Lembrete de Agenda Familiar*\n\nüìå *Evento:* ${titulo}`;
        
        if (descricao && descricao.trim() !== "" && descricao !== "undefined") {
            texto += `\nüìù *Descri√ß√£o:* ${descricao}`;
        }
        
        texto += `\n‚è∞ J√° est√° chegando a hora!`;
    
        const url = `https://api.whatsapp.com/send?phone=${telefone}&text=${encodeURIComponent(texto)}`;
        window.open(url, '_blank');
    }
    
</script>

</body>
</html>






